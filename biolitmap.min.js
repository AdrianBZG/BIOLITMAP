var articlesPerJournalChart;var articlesPerYearChart;var articlesPerTopicChart;let selectedYearsArray="2010,2011,2012,2013,2014";let selectedJournalsArray="Oxford Bioinformatics,BMC Bioinformatics,Nucleic Acids Research,BMC Genomics,PLoS Computational Biology";let selectedTopicsArray="\'Computational Biology > Molecular genetics\', \'Software > Tools\', \'Computational Biology > Nucleic acids > DNA\', \'Computational Biology > Nucleic acids > RNA\', \'Computational Biology > Phylogeny\', \'Computational Biology > Sequence analysis\', \'Computational Biology > Molecular interactions, pathways and networks\', \'Computational Biology > Structure analysis\', \'Omics > Genomics > Functional genomics\', \'Omics > Genomics > Pharmacogenomics\', \'Proteomics\', \'Omics > Genomics > Transcriptomics\', \'Computational Biology > Sequence analysis > Mapping\'"
var API_KEY='9d3d3e19781c35ce76c075e4cfe9d5caa1604ce9',USER_NAME='carto-bsc',SQL_CLIENT=axios.create({method:'get',url:'https://'+USER_NAME+'.carto.com/api/v2/sql?',params:{api_key:API_KEY}});function updatePerJournalPlot(){var query="SELECT source,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE year IN ("+selectedYearsArray+") AND source IN ("+selectedJournalsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY source";SQL_CLIENT.request({params:{q:query},}).then(function(response){if(response&&response.data){dataArray=[];labelsArray=[];var colorsArray=[];for(var i=0;i<response.data.rows.length;i++){dataArray.push(response.data.rows[i].sum);labelsArray.push(response.data.rows[i].source);colorsArray.push(getJournalColor(response.data.rows[i].source))}
options={};data={datasets:[{data:dataArray,backgroundColor:colorsArray}],labels:labelsArray};$("#map").css('z-index',1);$("#histogram").css('z-index',2);$("#articlesPerJournalChart").css('z-index',3);if(articlesPerJournalChart){$('#articlesPerJournalChart').remove();$('#histogram').append('<canvas id="articlesPerJournalChart"><canvas>');var ctx=$("#articlesPerJournalChart");articlesPerJournalChart=new Chart(ctx,{type:'pie',data:data,options:{maintainAspectRatio:!0,legend:{position:'left'},},borderWidth:1})}else{var ctx=$("#articlesPerJournalChart");articlesPerJournalChart=new Chart(ctx,{type:'pie',data:data,options:{maintainAspectRatio:!0,legend:{position:'left'},},borderWidth:1})}}}).catch(function(error){});hidePlots()}
function updatePerYearPlot(){var query="SELECT year,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE year IN ("+selectedYearsArray+") AND source IN ("+selectedJournalsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY year ORDER by year ASC";SQL_CLIENT.request({params:{q:query},}).then(function(response){if(response&&response.data){dataArray=[];labelsArray=[];for(var i=0;i<response.data.rows.length;i++){dataArray.push(response.data.rows[i].sum);labelsArray.push(response.data.rows[i].year)}
options={};data={datasets:[{data:dataArray,backgroundColor:'#feb236',hoverBackgroundColor:'#feb236'}],labels:labelsArray};$("#map").css('z-index',1);$("#histogram").css('z-index',2);$("#articlesPerYearChart").css('z-index',3);if(articlesPerYearChart){$('#articlesPerYearChart').remove();$('#histogram').append('<canvas id="articlesPerYearChart"><canvas>');var ctx=$("#articlesPerYearChart");articlesPerYearChart=new Chart(ctx,{type:'bar',data:data,options:{maintainAspectRatio:!0,legend:{display:!1},},borderWidth:1})}else{var ctx=$("#articlesPerYearChart");articlesPerYearChart=new Chart(ctx,{type:'bar',data:data,options:{maintainAspectRatio:!0,legend:{display:!1}},borderWidth:1})}}}).catch(function(error){});hidePlots()}
function updatePerTopicPlot(){var query="SELECT edamcategory,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE year IN ("+selectedYearsArray+") AND source IN ("+selectedJournalsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY edamcategory ORDER by edamcategory ASC";SQL_CLIENT.request({params:{q:query},}).then(function(response){if(response&&response.data){dataArray=[];labelsArray=[];var colorsArray=[];for(var i=0;i<response.data.rows.length;i++){dataArray.push(response.data.rows[i].sum);labelToPush=response.data.rows[i].edamcategory.split(">");labelToPush=labelToPush[labelToPush.length-1];if(labelToPush.includes("Molecular interactions")){labelToPush="Mol. int., pathways and networks"}
labelsArray.push(labelToPush.trim());colorsArray.push(getTopicColor(labelToPush))}
options={};data={datasets:[{data:dataArray,backgroundColor:colorsArray,hoverBackgroundColor:colorsArray}],labels:labelsArray};$("#map").css('z-index',1);$("#histogram").css('z-index',2);$("#articlesPerTopicChart").css('z-index',3);if(articlesPerTopicChart){$('#articlesPerTopicChart').remove();$('#histogram').append('<canvas id="articlesPerTopicChart" width="100%" height="80%"><canvas>');var ctx=$("#articlesPerTopicChart");articlesPerTopicChart=new Chart(ctx,{type:'pie',data:data,options:{maintainAspectRatio:!0,legend:{position:'left'},},borderWidth:1})}else{var ctx=$("#articlesPerTopicChart");articlesPerTopicChart=new Chart(ctx,{type:'pie',data:data,options:{maintainAspectRatio:!0,legend:{position:'left'},},borderWidth:1})}}}).catch(function(error){});hidePlots()}
function componentToHex(c){var hex=c.toString(16);return hex.length==1?"0"+hex:hex}
function getJournalColor(journal){switch(journal.trim()){case "BMC Genomics":return'#006E51';case "Oxford Bioinformatics":return'#D8AE47';case "Nucleic Acids Research":return'#034F84';case "BMC Bioinformatics":return'#955251';case "PLoS Computational Biology":return'#009B77';default:return'#000000'}}
function getTopicColor(topic){switch(topic.trim()){case "DNA":return'#FE2712';case "RNA":return'#FC600A';case "Phylogeny":return'#FB9902';case "Sequence analysis":return'#FCCC1A';case "Mapping":return'#FEFE33';case "Structure analysis":return'#B2D732';case "Functional genomics":return'#66B032';case "Pharmacogenomics":return'#8601AF';case "Proteomics":return'#C21460';case "Mol. int., pathways and networks":return'#6C4F3D';case "Molecular genetics":return'#672E3B';case "Transcriptomics":return'#9C9A40';case "Tools":return'#F6D155';default:return'#000000'}}
function getColorsArray(size){var rainbow=["#fbb735","#e98931","#eb403b","#b32E37","#6c2a6a","#5c4399","#274389","#1f5ea8","#227FB0","#2ab0c5","#39c0b3",'#b3cae5','#dbdde4','#e4e3e4','#f7ddbb','#efcab2','#bccacc','#c7d8d6','#d9ebe0','#ebf9e3','#f4f8d0','#5e7fb1','#dce8f7','#eff1f4','#fce1a8','#f7ec86','#8fb8ee','#cbe2f4','#dbe5eb','#f9d3b8','#e0b2a3','#a2e0f9','#cef5fc','#eafaeb','#fefcd3','#fdf4ba','#6bafd2','#a4c8dc','#d6cbca','#eabc96','#db8876','#b4ced8','#d7e5d4','#e2e8c9','#f1e5b9','#edd7ac','#29153e','#657489','#bfb6aa','#ead79d','#f2ebda','#20202f','#273550','#416081','#adacb2','#eac3a2','#555351','#555351','#8d7b6c','#cc9d7a','#fff9aa','#171c33','#525f83','#848896','#bb9d78','#f6e183','#ffe3c8','#efad9e','#c79797','#a78a92','#857d8d','#6f749e','#9a8daf','#d0a8b9','#f8bbb1','#fde6b1','#536a97','#8087ad','#bca391','#bd968a','#a38b8a','#325176','#7b9ea7','#9baf93','#dbaf81','#fbdf73','#727288','#8e889b','#d3c2bd','#f9d89a','#f8c785','#506e90','#7695aa','#a7bdb8','#e2e2b8','#fdf998','#634b5f','#868080','#b7b29b','#dfd6a4','#e9f3a2','#7e74b2','#b3a2c2','#e2cdbe','#f6cf97','#f4a77a','#34a4ca','#59d7dd','#a8f2f0','#d0f8ef','#d6f6e1','#7696cd','#8fb2e4','#b0cff0','#d7e5ec','#dee0e7','#8dd6c3','#c5e5e2','#eafaeb','#f9f7ca','#fceea1','#4e72c7','#6d9ed7','#a4c8d5','#b4d9e1','#c4d9d6','#47565f','#5b625a','#947461','#f98056','#f7ec86','#95b3bf','#c6cdd3','#e5d8d9','#f1e1d9','#f3e1cd','#4c86ab','#95a5bc','#bfcdc9','#dcd6c9','#edd9c7','#0f124a','#1b2360','#515b80','#758391','#e5e3b0','#889db6','#a5b8ce','#c1cfdd','#dee1e4','#d5d1cf','#74bddb','#a8d1eb','#cddbf5','#e4e6fb','#f6f4f8','#a7d3cb','#bcc1c4','#e5cab3','#fee6c5','#fdecd0','#325571','#8e9fa4','#decab2','#f2d580','#ffa642','#c5d4d7','#d6b98d','#c99262','#8c5962','#43577e'];var colors=[];while(colors.length<size){do{var color=Math.floor((Math.random()*1000000)+1)}while(colors.indexOf(color)>=0);colors.push(componentToHex(rainbow[colors.length]))}
return colors}
function hidePlots(){$('#articlesPerJournalChartTitle').hide();$('#articlesPerJournalChart').hide();$('#articlesPerYearChartTitle').hide();$('#articlesPerYearChart').hide();$('#articlesPerTopicChartTitle').hide();$('#articlesPerTopicChart').hide();$('#histogram').hide();map.closePopup()}
function main(){const style=$("#style").text();const query=_.template($('#query').html());const slider_container=$('#slider-container');const slider=$('#slider-cities');map=L.map('map',{zoomControl:!1,center:[41.85,1.85],zoom:4,minZoom:2,maxZoom:18});L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}.png',{maxZoom:18,zIndex:0}).addTo(map);L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_only_labels/{z}/{x}/{y}.png',{maxZoom:18,zIndex:0}).addTo(map);L.control.zoom({position:'bottomleft'}).addTo(map);const client=new carto.Client({apiKey:'9d3d3e19781c35ce76c075e4cfe9d5caa1604ce9',username:'carto-bsc'});let citiesSource=new carto.source.SQL(query({cities:500,year:selectedYearsArray,journal:selectedJournalsArray,edamcat:selectedTopicsArray})),citiesStyle=new carto.style.CartoCSS(style),citiesLayer=new carto.layer.Layer(citiesSource,citiesStyle,{featureClickColumns:['name','papers']});client.addLayer(citiesLayer);client.getLeafletLayer().addTo(map)
$(document).ready(function(){$('.modal').on('hidden.bs.modal',function(e)
{$(this).removeData()});$('[data-toggle="tooltip"]').tooltip()
$("[data-toggle=tooltip]").tooltip({placement:$(this).data("placement")||'top'});selectedYearsArray="2010,2011,2012,2013,2014";selectedJournalsArray="Oxford Bioinformatics,BMC Bioinformatics,Nucleic Acids Research,BMC Genomics,PLoS Computational Biology";selectedTopicsArray="\'Computational Biology > Molecular genetics\', \'Software > Tools\', \'Computational Biology > Nucleic acids > DNA\', \'Computational Biology > Nucleic acids > RNA\', \'Computational Biology > Phylogeny\', \'Computational Biology > Sequence analysis\', \'Computational Biology > Molecular interactions, pathways and networks\', \'Computational Biology > Structure analysis\', \'Omics > Genomics > Functional genomics\', \'Omics > Genomics > Pharmacogenomics\', \'Proteomics\', \'Omics > Genomics > Transcriptomics\', \'Computational Biology > Sequence analysis > Mapping\'"
dragElement(document.getElementById(("histogram")));function dragElement(elmnt){var pos1=0,pos2=0,pos3=0,pos4=0;if(document.getElementById(elmnt.id+"header")){document.getElementById(elmnt.id+"header").onmousedown=dragMouseDown}else{elmnt.onmousedown=dragMouseDown}
function dragMouseDown(e){e=e||window.event;pos3=e.clientX;pos4=e.clientY;document.onmouseup=closeDragElement;document.onmousemove=elementDrag}
function elementDrag(e){e=e||window.event;pos1=pos3-e.clientX;pos2=pos4-e.clientY;pos3=e.clientX;pos4=e.clientY;elmnt.style.top=(elmnt.offsetTop-pos2)+"px";elmnt.style.left=(elmnt.offsetLeft-pos1)+"px"}
function closeDragElement(){document.onmouseup=null;document.onmousemove=null}}
$('#leftSidebar').hide();$('#histogram').hide();$('#articlesPerJournalChartTitle').hide();$('#articlesPerJournalChart').hide();$('#articlesPerYearChartTitle').hide();$('#articlesPerYearChart').hide();$('#articlesPerTopicChartTitle').hide();$('#articlesPerTopicChart').hide();$("#histogramClose").click(function(){hidePlots()});$("#sidebarButtonOpen").click(function(){$('#sidebarButtonClosed').show();$('#leftSidebar').fadeOut()});$("#sidebarButtonClosed").click(function(){$('#sidebarButtonClosed').hide();$('#leftSidebar').fadeIn()});$("#plotArticlesPerJournal").click(function(){hidePlots();$('#histogram').fadeIn();$('#articlesPerJournalChartTitle').fadeIn();$('#articlesPerJournalChart').fadeIn()});$("#plotArticlesPerYear").click(function(){hidePlots();$('#histogram').fadeIn();$('#articlesPerYearChartTitle').fadeIn();$('#articlesPerYearChart').fadeIn()});$("#plotArticlesPerTopic").click(function(){hidePlots();$('#histogram').fadeIn();$('#articlesPerTopicChartTitle').fadeIn();$('#articlesPerTopicChart').fadeIn()});SQL_CLIENT.request({params:{q:"SELECT source,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE source IN ('Nucleic Acids Research', 'Oxford Bioinformatics', 'BMC Genomics', 'BMC Bioinformatics', 'PLoS Computational Biology') GROUP BY source"},}).then(function(response){if(response&&response.data){dataArray=[];labelsArray=[];for(var i=0;i<response.data.rows.length;i++){dataArray.push(response.data.rows[i].sum);labelsArray.push(response.data.rows[i].source)}
options={};data={datasets:[{data:dataArray,backgroundColor:getColorsArray(dataArray.length)}],labels:labelsArray};$("#map").css('z-index',1);$("#histogram").css('z-index',2);$("#articlesPerJournalChart").css('z-index',3);var ctx=$("#articlesPerJournalChart");var articlesPerJournalChart=new Chart(ctx,{type:'pie',data:data,options:{maintainAspectRatio:!1,legend:{position:'left'},},borderWidth:1})}}).catch(function(error){});SQL_CLIENT.request({params:{q:"SELECT year,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE year IN (2010,2011,2012,2013,2014) GROUP BY year ORDER by year ASC"},}).then(function(response){if(response&&response.data){dataArray=[];labelsArray=[];for(var i=0;i<response.data.rows.length;i++){dataArray.push(response.data.rows[i].sum);labelsArray.push(response.data.rows[i].year)}
options={};data={datasets:[{data:dataArray,backgroundColor:getColorsArray(0),hoverBackgroundColor:getColorsArray(0)}],labels:labelsArray};$("#map").css('z-index',1);$("#histogram").css('z-index',2);$("#articlesPerYearChart").css('z-index',3);var ctx=$("#articlesPerYearChart");var articlesPerJournalChart=new Chart(ctx,{type:'bar',data:data,options:{maintainAspectRatio:!1,legend:{display:!1}},borderWidth:1})}}).catch(function(error){});SQL_CLIENT.request({params:{q:"SELECT edamcategory,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE year IN (2010,2011,2012,2013,2014) GROUP BY edamcategory ORDER by edamcategory ASC"},}).then(function(response){if(response&&response.data){dataArray=[];labelsArray=[];for(var i=0;i<response.data.rows.length;i++){dataArray.push(response.data.rows[i].sum);labelToPush=response.data.rows[i].edamcategory.split(">");labelToPush=labelToPush[labelToPush.length-1];if(labelToPush.includes("Molecular interactions")){labelToPush="Mol. int., pathways and networks"}
labelsArray.push(labelToPush)}
options={};data={datasets:[{data:dataArray,backgroundColor:getColorsArray(dataArray.length),hoverBackgroundColor:getColorsArray(dataArray.length)}],labels:labelsArray};$("#map").css('z-index',1);$("#histogram").css('z-index',2);$("#articlesPerTopicChart").css('z-index',3);var ctx=$("#articlesPerTopicChart");var articlesPerTopicChart=new Chart(ctx,{type:'pie',data:data,options:{maintainAspectRatio:!0,legend:{display:'left'}},borderWidth:1})}}).catch(function(error){});$('#topicSelector').multiselect({includeSelectAllOption:!0,allSelectedText:'All topics selected',buttonWidth:'200px',onChange:function(option,checked){},buttonText:function(options){if(options.length>0){var selected=[];options.each(function(){selected.push([$(this).val(),$(this).data('order')])});selected.sort(function(a,b){return a[1]-b[1]});var text='';for(var i=0;i<selected.length;i++){text+=selected[i][0]+', '}
selectedTopicsArray=text.substr(0,text.length-2);citiesSource.setQuery(query({cities:500,year:selectedYearsArray,journal:selectedJournalsArray,edamcat:selectedTopicsArray}))
citiesLayer=new carto.layer.Layer(citiesSource,citiesStyle,{featureClickColumns:['name','papers']});updatePerYearPlot();updatePerJournalPlot();updatePerTopicPlot();hidePlots()}
if(options.length===0){citiesSource.setQuery(query({cities:500,year:['9999'],journal:selectedJournalsArray,edamcat:selectedTopicsArray}))
selectedTopicsArray=['9999'];citiesLayer=new carto.layer.Layer(citiesSource,citiesStyle,{featureClickColumns:['name','papers']});return'0 topics selected'}else{return options.length+' topics selected'}}},'selectAll');$('option',$('#topicSelector')).each(function(index,element){$(this).removeAttr('selected').prop('selected',!0)});$("#topicSelector").multiselect('refresh');$('#yearSelector').multiselect({includeSelectAllOption:!0,allSelectedText:'All years selected',buttonWidth:'200px',onChange:function(option,checked){},buttonText:function(options){if(options.length>0){var selected=[];options.each(function(){selected.push([$(this).text(),$(this).data('order')])});selected.sort(function(a,b){return a[1]-b[1]});var text='';for(var i=0;i<selected.length;i++){text+=selected[i][0]+', '}
selectedYearsArray=text.substr(0,text.length-2);citiesSource.setQuery(query({cities:500,year:selectedYearsArray,journal:selectedJournalsArray,edamcat:selectedTopicsArray}))
citiesLayer=new carto.layer.Layer(citiesSource,citiesStyle,{featureClickColumns:['name','papers']});updatePerYearPlot();updatePerJournalPlot();updatePerTopicPlot();hidePlots()}
if(options.length===0){citiesSource.setQuery(query({cities:500,year:['9999'],journal:selectedJournalsArray,edamcat:selectedTopicsArray}))
citiesLayer=new carto.layer.Layer(citiesSource,citiesStyle,{featureClickColumns:['name','papers']});selectedYearsArray=['9999'];return'0 years selected'}else{return options.length+' years selected'}}},'selectAll');$('#journalsSelector').multiselect({includeSelectAllOption:!0,allSelectedText:'All journals selected',buttonWidth:'200px',onChange:function(option,checked){},buttonText:function(options){if(options.length>0){var selected=[];options.each(function(){selected.push([$(this).text(),$(this).data('order')])});selected.sort(function(a,b){return a[1]-b[1]});var text='';for(var i=0;i<selected.length;i++){text+="'"+selected[i][0]+"'"+', '}
selectedJournalsArray=text.substr(0,text.length-2);citiesSource.setQuery(query({cities:500,year:selectedYearsArray,journal:selectedJournalsArray,edamcat:selectedTopicsArray}))
citiesLayer=new carto.layer.Layer(citiesSource,citiesStyle,{featureClickColumns:['name','papers']});updatePerYearPlot();updatePerJournalPlot();updatePerTopicPlot();hidePlots()}
if(options.length===0){citiesSource.setQuery(query({cities:500,year:['9999'],journal:selectedJournalsArray,edamcat:selectedTopicsArray}))
citiesLayer=new carto.layer.Layer(citiesSource,citiesStyle,{featureClickColumns:['name','papers']});selectedJournalsArray=['9999'];return'0 journals selected'}else{return options.length+' journals selected'}}},'selectAll');$('option',$('#journalsSelector')).each(function(index,element){$(this).removeAttr('selected').prop('selected',!0)});$("#journalsSelector").multiselect('refresh');$('option',$('#yearSelector')).each(function(index,element){if(index<6){$(this).removeAttr('selected').prop('selected',!1)}
if(index>4){$(this).removeAttr('selected').prop('selected',!0)}
if(index>9){$(this).removeAttr('selected').prop('selected',!1)}});$("#yearSelector").multiselect('refresh')});const popup=L.popup({closeButton:!0});function openPopup(featureEvent){popup.setLatLng(featureEvent.latLng);if(!popup.isOpen()){let content='';content+=`<div class="popup-container" id="institutionWindow">`;if(featureEvent.data.name){var query="";if(featureEvent.data.name=="CSIC (Spanish National Research Council)"){console.log("CSIC count");query="SELECT COUNT(*) AS sum FROM articles_global_v1 WHERE nameaffiliation LIKE '%CSIC%' AND source IN ("+selectedJournalsArray+") AND edamcategory IN ("+selectedTopicsArray+") AND year IN ("+selectedYearsArray+")"}else if(featureEvent.data.name=="Universidad Autónoma de Madrid"){console.log("UAM count");query="SELECT COUNT(*) AS sum FROM articles_global_v1 WHERE nameaffiliation = 'Universidad Autónoma de Madrid' AND source IN ("+selectedJournalsArray+") AND edamcategory IN ("+selectedTopicsArray+") AND year IN ("+selectedYearsArray+")"}
else{query="SELECT SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE nameaffiliation = '"+featureEvent.data.name+"' AND source IN ("+selectedJournalsArray+") AND edamcategory IN ("+selectedTopicsArray+") AND year IN ("+selectedYearsArray+")"}
SQL_CLIENT.request({params:{q:query},}).then(function(response){if(response&&response.data){var numberPapers=response.data.rows[0].sum;content+=`<h4>INSTITUTION: ${featureEvent.data.name}</h4>`;content+=`<br>`;content+=`<p><b>PAPERS ON THIS PERIOD:</b> ${numberPapers}</p>`;content+=`<center><button type="button" id ="mostrarArticulosInstitucion" data-toggle="tooltip" data-placement="right" title="View the articles of this institution" class="btn btn-primary" style="z-index: 10; width: 70%;">View articles</button></center><br>`;content+=`<canvas id="bar-chart" width="400" height="250"></canvas><br>`;content+=`<canvas id="insPerTopicPieChart" width="500" height="250"></canvas>`;content+=`</div>`;content+=`<!-- Modal -->
<div id="myModal" class="modal fade" role="dialog">
  <div class="modal-dialog modal-lg">

    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Articles from this institution</h4><button type="button" id ="printArticulosInstitucion" data-toggle="tooltip" data-placement="right" title="Print the articles of this institution" class="btn btn-primary" style="z-index: 10; width: 30%;">Print</button>
      </div>
      <div class="modal-body">
        <table class="table">
    <thead>
      <tr>
        <th>Title</th>
        <th>Year</th>
        <th>Source</th>
		<th>EDAM Category</th>
		<th>Citations</th>
		<th>DOI</th>
      </tr>
    </thead>
    <tbody id="cuerpoTablaArticulos">
      <tr>
        
      
    </tbody>
  </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>

  </div>
</div>`;popup.setContent(content);popup.openOn(map);$("#mostrarArticulosInstitucion").click(function(){console.log('Hi');var qry="";if(featureEvent.data.name=="CSIC (Spanish National Research Council)"){qry="SELECT title,year,source,edamCategory,citations,doi FROM articles_global_v1 WHERE nameaffiliation LIKE '%CSIC%' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") ORDER by year ASC"}else{qry="SELECT title,year,source,edamCategory,citations,doi FROM articles_global_v1 WHERE nameaffiliation = '"+featureEvent.data.name+"' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") ORDER by year ASC"}
SQL_CLIENT.request({params:{q:qry},}).then(function(response){if(response&&response.data){}
console.log(response.data);$('#myModal').removeData();$('#cuerpoTablaArticulos').empty();for(var z=0;z<response.data.rows.length;z++){console.log(z);$('#cuerpoTablaArticulos').append('<tr>'+'<td>'+response.data.rows[z].title+'</td>'+'<td>'+response.data.rows[z].year+'</td>'+'<td>'+response.data.rows[z].source+'</td>'+'<td>'+response.data.rows[z].edamcategory+'</td>'+'<td>'+response.data.rows[z].citations+'</td>'+'<td>'+"<a href=\"http://dx.doi.org/"+response.data.rows[z].doi+"\" target=\"_blank\">"+response.data.rows[z].doi+'</a></td>'+'<td>')}
$('#cuerpoTablaArticulos').append('</tr>');$('#myModal').appendTo("body").modal('show')}).catch(function(error){})});$("#printArticulosInstitucion").click(function(){var headerVar="<h1>This data has been downloaded from BIOLITMAP</h1>Institution: "+featureEvent.data.name+"</br></br>";$(".modal-body").last().printThis({header:headerVar})});var numberWithCommas=function(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};var dataPack1=[40];var dataPack2=[10];var dataPacks=[];var dates=[featureEvent.data.year];var query="";if(featureEvent.data.name=="CSIC (Spanish National Research Council)"){console.log("CSIC");query="SELECT source,year,COUNT(*) as sum FROM articles_global_v1 WHERE nameaffiliation LIKE '%CSIC%' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY year,source ORDER by year ASC"}else if(featureEvent.data.name=="Universidad Autónoma de Madrid"){console.log("UAM");query="SELECT source,year,COUNT(*) as sum FROM articles_global_v1 WHERE nameaffiliation = 'Universidad Autónoma de Madrid' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY year,source ORDER by year ASC"}
else{query="SELECT source,year,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE nameaffiliation = '"+featureEvent.data.name+"' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY year,source ORDER by year ASC"}
SQL_CLIENT.request({params:{q:query},}).then(function(response){if(response&&response.data){console.log("Cuenta");console.log(response);dataArray=[];labelsArray=[];var journalsArray=[]
var yearsArray=selectedYearsArray.split(",");for(var i=0;i<response.data.rows.length;i++){if(!journalsArray.includes(response.data.rows[i].source)){journalsArray.push(response.data.rows[i].source)}}
journalsArray=selectedJournalsArray.split(",");for(var x=0;x<journalsArray.length;x++){journalsArray[x]=journalsArray[x].replace(/'/g,'').trim()}
for(var i=0;i<selectedYearsArray.split(",").length;i++){if(!labelsArray.includes(parseInt(selectedYearsArray.split(",")[i].trim(),10))){labelsArray.push(parseInt(selectedYearsArray.split(",")[i].trim(),10))}}
labelsArray.sort(function(a,b){return a-b});var numberYears=labelsArray.length;var numberJournals=journalsArray.length;datapackColors=getColorsArray(numberJournals);for(var i=0;i<numberJournals;i++){var tempDataArray=[];var tempYearArray=[];var datapackLabel;for(var t=0;t<selectedYearsArray.split(",").length;t++){tempDataArray.push({year:parseInt(selectedYearsArray.split(",")[t].trim(),10),value:0})}
for(var j=0;j<response.data.rows.length;j++){if(response.data.rows[j].source==journalsArray[i]){for(var l=0;l<tempDataArray.length;l++){if(parseInt(response.data.rows[j].year,10)==tempDataArray[l].year){tempDataArray[l].value=response.data.rows[j].sum}}
if(!tempYearArray.includes(parseInt(response.data.rows[j].year,10))){tempYearArray.push(parseInt(response.data.rows[j].year,10))}}}
finalDataArray=[];for(var l=0;l<tempDataArray.length;l++){finalDataArray.push(tempDataArray[l].value)}
var datapackObject={label:journalsArray[i],data:finalDataArray,backgroundColor:getJournalColor(journalsArray[i]),hoverBackgroundColor:getJournalColor(journalsArray[i]),hoverBorderWidth:2,hoverBorderColor:'lightgrey'};dataPacks.push(datapackObject)}
var bar_ctx=document.getElementById('bar-chart');var bar_chart=new Chart(bar_ctx,{type:'bar',data:{labels:labelsArray,datasets:dataPacks},options:{title:{display:!0,text:'Articles per year and per journal with the selected filters'},animation:{duration:10,},tooltips:{mode:'label',position:'nearest',intersection:!1,callbacks:{label:function(tooltipItem,data){return data.datasets[tooltipItem.datasetIndex].label+": "+numberWithCommas(tooltipItem.yLabel)}}},scales:{xAxes:[{stacked:!0,gridLines:{display:!1},}],yAxes:[{stacked:!0,ticks:{beginAtZero:!0,callback:function(value){if(value%1===0){return value}}},}],},legend:{display:!1}}})}}).catch(function(error){});if(featureEvent.data.name=="CSIC (Spanish National Research Council)"){console.log("CSIC");query2="SELECT edamcategory,COUNT(*) as sum FROM articles_global_v1 WHERE nameaffiliation LIKE '%CSIC%' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY edamcategory ORDER by edamcategory ASC"}else if(featureEvent.data.name=="Universidad Autónoma de Madrid"){console.log("UAM");query2="SELECT edamcategory,COUNT(*) as sum FROM articles_global_v1 WHERE nameaffiliation = '"+featureEvent.data.name+"' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY edamcategory ORDER by edamcategory ASC"}
else{query2="SELECT edamcategory,SUM(CAST(num_papers AS INT)) FROM results_full_280218_v1 WHERE nameaffiliation = '"+featureEvent.data.name+"' AND source IN ("+selectedJournalsArray+") AND year IN ("+selectedYearsArray+") AND edamcategory IN ("+selectedTopicsArray+") GROUP BY edamcategory ORDER by edamcategory ASC"}
SQL_CLIENT.request({params:{q:query2},}).then(function(response){if(response&&response.data){dataArray=[];labelsArray=[];var colorsArray=[]
for(var i=0;i<response.data.rows.length;i++){dataArray.push(response.data.rows[i].sum);labelToPush=response.data.rows[i].edamcategory.split(">");labelToPush=labelToPush[labelToPush.length-1];if(labelToPush.includes("Molecular interactions")){labelToPush="Mol. int., pathways and networks"}
labelsArray.push(labelToPush.trim());colorsArray.push(getTopicColor(labelToPush))}
data={datasets:[{data:dataArray,backgroundColor:colorsArray}],labels:labelsArray};var insPerTopicChart_ctx=document.getElementById('insPerTopicPieChart');var insPerTopicChart=new Chart(insPerTopicChart_ctx,{type:'doughnut',data:data,options:{title:{display:!0,text:'Articles per topic with the selected filters'},legend:{display:!1}},borderWidth:1})}}).catch(function(error){})}}).catch(function(error){})}}}
function closePopup(featureEvent){popup.removeFrom(map)}
citiesLayer.on('featureClicked',openPopup)}
window.onload=main